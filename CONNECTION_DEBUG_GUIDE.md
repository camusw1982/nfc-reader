# WebSocket 連接調試指南

## 🔍 問題診斷

根據您的日誌，問題是：
1. WebSocket 任務創建成功
2. 收到連接確認消息
3. 但是 ping 發送失敗（"WebSocket 任務不存在"）

## 📋 調試步驟

### 1. 檢查連接流程
運行應用程式後，您應該看到以下日誌順序：

```
🔌 連接到 WebSocket: ws://145.79.12.177:10000
🔌 WebSocket 任務已創建並開始
📨 收到 WebSocket 消息: {"type": "connection", "status": "connected"...}
🔌 收到連接確認消息
📡 發送 ping 測試連接
🏓 收到 pong 回應，連接正常
✅ 連接狀態已設置為已連接
```

### 2. 如果看到錯誤
如果看到以下錯誤，請檢查：

**❌ WebSocket 任務不存在，無法發送消息**
- 這表示 `webSocketTask` 被設為 `nil`
- 可能的原因：連接在 ping 發送前就斷開了

**❌ 接收消息失敗: [錯誤信息]**
- 這表示 WebSocket 連接有問題
- 請檢查網絡連接和服務器狀態

### 3. 手動測試連接
在應用程式中，您可以：
1. 嘗試發送語音消息
2. 檢查是否收到回應
3. 查看控制台日誌

## 🔧 修復措施

我已經做了以下修復：

1. **延遲 ping 發送**：從 1 秒延遲到 2 秒，確保連接完全建立
2. **添加連接檢查**：ping 發送前檢查 `webSocketTask` 是否存在
3. **恢復錯誤日誌**：重新顯示重要的連接錯誤
4. **改進錯誤過濾**：只過濾真正無害的錯誤

## 📱 預期的正常日誌

```
📱 設備連接 ID: [ID]
🎵 音頻會話設置成功
✅ MiniMax 管理器已初始化
🔌 連接到 WebSocket: ws://145.79.12.177:10000
🔌 WebSocket 任務已創建並開始
📨 收到 WebSocket 消息: {"type": "connection", "status": "connected"...}
🔌 收到連接確認消息
📡 發送 ping 測試連接
🏓 收到 pong 回應，連接正常
✅ 語音識別權限已授予
✅ 語音控制管理器初始化完成
✅ 語音識別可用
```

## 🚨 如果問題持續

如果連接問題持續，請：

1. **檢查服務器狀態**：確保 WebSocket 服務器正在運行
2. **檢查網絡連接**：確保 iPhone 可以訪問服務器
3. **重啟應用程式**：完全關閉並重新打開應用程式
4. **分享完整日誌**：提供從啟動到嘗試發送消息的完整日誌

## 📊 連接狀態指示

- **連接中...**：正在嘗試連接
- **已連接**：連接成功，可以發送消息
- **斷開連接**：連接失敗，正在嘗試重連
- **發送失敗**：連接存在但發送消息失敗

請運行應用程式並分享新的日誌輸出！
